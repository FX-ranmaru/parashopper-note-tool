<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚º noteè¨˜äº‹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
:root {
  --bg: #0d0d0f;
  --surface: #15151a;
  --surface2: #1e1e26;
  --border: #2a2a38;
  --accent: #f5a623;
  --accent2: #e8304a;
  --text: #e8e8f0;
  --muted: #888899;
  --success: #3ecf8e;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
  font-size: 14px;
  min-height: 100vh;
}
.header {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  display: flex; align-items: center; gap: 10px;
  position: sticky; top: 0; z-index: 100;
}
.header h1 { font-size: 1.2rem; color: var(--accent); font-weight: 900; letter-spacing: 2px; }
.header p { font-size: 0.68rem; color: var(--muted); }
.stepbar {
  display: flex; align-items: center; gap: 4px;
  padding: 10px 20px; border-bottom: 1px solid var(--border);
  background: var(--surface); overflow-x: auto;
}
.sbtn {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px; border-radius: 20px;
  border: none; background: none; cursor: pointer;
  color: var(--muted); font-size: 0.75rem; font-weight: 700;
  white-space: nowrap; font-family: inherit; transition: all 0.2s;
}
.sbtn.active { background: rgba(245,166,35,0.15); color: var(--accent); }
.sbtn.done { color: var(--success); }
.snum {
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--border); color: var(--muted);
  font-size: 0.65rem; font-weight: 700;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.sbtn.active .snum { background: var(--accent); color: #000; }
.sbtn.done .snum { background: var(--success); color: #000; }
.sarrow { color: var(--border); font-size: 0.9rem; flex-shrink: 0; }
.layout {
  display: grid; grid-template-columns: 1fr 1fr;
  height: calc(100vh - 95px);
}
.pane { padding: 18px 20px; overflow-y: auto; }
.pane-r { background: var(--surface); border-left: 1px solid var(--border); }
.sp { display: none; } .sp.on { display: block; }
.rp { display: none; } .rp.on { display: block; }
.stitle {
  font-size: 0.62rem; font-weight: 700; letter-spacing: 2px;
  text-transform: uppercase; color: var(--muted);
  margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
}
.stitle::after { content:''; flex:1; height:1px; background:var(--border); }
.upload-label {
  display: block; border: 2px dashed var(--border);
  border-radius: 10px; padding: 28px 16px;
  text-align: center; cursor: pointer;
  background: var(--surface2); transition: all 0.2s;
}
.upload-label:hover, .upload-label.drag {
  border-color: var(--accent); background: rgba(245,166,35,0.05);
}
#imgInput { display: none; }
.upload-icon { font-size: 2rem; display: block; margin-bottom: 8px; }
.upload-label p { color: var(--muted); line-height: 1.6; font-size: 0.82rem; }
.upload-label strong { color: var(--accent); }
.thumb-header {
  display: flex; justify-content: space-between; align-items: center;
  margin: 12px 0 8px;
}
.img-count { font-size: 0.72rem; color: var(--muted); }
.img-count span { color: var(--accent); font-weight: 700; }
.thumb-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
.thumb {
  position: relative; aspect-ratio: 3/4;
  border-radius: 6px; overflow: hidden;
  border: 1px solid var(--border); background: var(--surface2);
  cursor: grab; user-select: none; transition: transform 0.15s, opacity 0.15s;
}
.thumb img { width:100%; height:100%; object-fit:cover; pointer-events:none; display:block; }
.thumb-n {
  position:absolute; top:2px; left:2px;
  background:rgba(0,0,0,0.85); color:#fff;
  font-size:0.58rem; font-weight:700; padding:1px 4px; border-radius:2px;
}
.thumb-x {
  position:absolute; top:2px; right:2px;
  background:var(--accent2); color:#fff; border:none; border-radius:3px;
  width:16px; height:16px; font-size:0.58rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.thumb.dragging { opacity:0.25; transform:scale(0.93); }
.thumb.over { outline:2px solid var(--accent); transform:scale(1.05); }
.row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
.fg { margin-bottom:10px; }
label { display:block; font-size:0.68rem; color:var(--muted); margin-bottom:4px; }
input[type=text], input[type=number] {
  width:100%; background:var(--bg); border:1px solid var(--border);
  color:var(--text); border-radius:6px; padding:8px 10px;
  font-family:inherit; font-size:0.85rem; outline:none;
}
input:focus { border-color:var(--accent); }
.ebox {
  width:100%; background:var(--bg); border:1px solid var(--border);
  color:var(--text); border-radius:6px; padding:8px 10px;
  font-family:inherit; font-size:0.82rem; line-height:1.7;
  outline:none; min-height:75px; white-space:pre-wrap; word-break:break-word; cursor:text;
}
.ebox.tall { min-height:115px; }
.ebox:focus { border-color:var(--accent); }
.ebox[data-ph]:empty::before { content:attr(data-ph); color:#444455; pointer-events:none; }
.aff-box { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:12px; }
.aff-row { display:flex; align-items:center; gap:7px; margin-bottom:6px; }
.aff-row:last-child { margin-bottom:0; }
.vol-tag { font-size:0.62rem; font-weight:700; color:var(--accent); background:rgba(245,166,35,0.12); padding:2px 5px; border-radius:3px; min-width:26px; text-align:center; flex-shrink:0; }
.aff-in { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:4px; padding:5px 8px; font-family:inherit; font-size:0.72rem; outline:none; }
.aff-in:focus { border-color:var(--accent); }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:10px 16px; border-radius:6px; font-family:inherit; font-size:0.82rem; font-weight:700; cursor:pointer; border:none; transition:all 0.15s; }
.btn-main { background:var(--accent); color:#000; width:100%; padding:12px; margin-top:6px; }
.btn-main:hover { background:#ffc04d; }
.btn-main:disabled { background:var(--border); color:var(--muted); cursor:not-allowed; }
.btn-sub { background:transparent; color:var(--muted); border:1px solid var(--border); font-size:0.75rem; padding:8px 12px; }
.btn-sub:hover { border-color:var(--accent); color:var(--accent); }
.btn-copy { background:var(--success); color:#000; padding:9px 16px; font-size:0.75rem; }
.btn-copy:hover { background:#5ee8a8; }
.btn-del { background:transparent; border:1px solid var(--border); color:var(--muted); padding:9px 14px; font-size:0.75rem; }
.btn-del:hover { border-color:var(--accent2); color:var(--accent2); }
.btn-row { display:flex; gap:8px; margin-top:8px; }
.tip { font-size:0.68rem; color:var(--muted); line-height:1.5; background:rgba(245,166,35,0.04); border-left:2px solid var(--accent); padding:6px 10px; border-radius:0 4px 4px 0; margin-bottom:10px; }
.vinfo { display:none; font-size:0.68rem; color:var(--muted); padding:5px 10px; background:rgba(245,166,35,0.05); border-left:2px solid var(--accent); border-radius:0 4px 4px 0; margin-bottom:10px; }
.loading { display:none; align-items:center; gap:10px; color:var(--muted); font-size:0.8rem; padding:12px 0; }
.loading.on { display:flex; }
.spin { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; flex-shrink:0; }
@keyframes spin { to { transform:rotate(360deg); } }
.progress-wrap { margin:6px 0 0; }
.progress-bar { height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
.progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s; width:0%; }
.progress-text { font-size:0.65rem; color:var(--muted); margin-top:3px; }
.preview-box, .out-box { background:var(--bg); border:1px solid var(--accent); border-radius:8px; padding:14px; font-size:0.8rem; line-height:1.8; white-space:pre-wrap; word-break:break-word; color:var(--text); min-height:160px; }
.out-box { border-color:var(--border); }
.preview-ph, .out-ph { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:160px; color:var(--muted); font-size:0.75rem; gap:8px; text-align:center; }
.out-actions { display:flex; gap:8px; margin-top:10px; align-items:center; }
.copied { color:var(--success); font-size:0.72rem; display:none; }
.copied.on { display:inline; }
.ai-badge { display:inline-flex; align-items:center; gap:4px; background:rgba(245,166,35,0.12); border:1px solid rgba(245,166,35,0.3); color:var(--accent); font-size:0.6rem; font-weight:700; padding:2px 7px; border-radius:3px; margin-bottom:8px; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
@media (max-width:700px) {
  .layout { grid-template-columns:1fr; height:auto; }
  .pane-r { border-left:none; border-top:1px solid var(--border); }
  .thumb-grid { grid-template-columns:repeat(4,1fr); }
  .row2 { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<div class="header">
  <h1>âš¡ PARA NOTE GEN</h1>
  <p>ãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚º noteè¨˜äº‹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</p>
</div>

<div class="stepbar">
  <button class="sbtn active" id="sb1" onclick="goStep(1)"><span class="snum">1</span>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  <span class="sarrow">â€º</span>
  <button class="sbtn" id="sb2" onclick="goStep(2)"><span class="snum">2</span>ã‚ã‚‰ã™ã˜ç¢ºèªãƒ»ç·¨é›†</button>
  <span class="sarrow">â€º</span>
  <button class="sbtn" id="sb3" onclick="goStep(3)"><span class="snum">3</span>noteè¨˜äº‹ã‚’ç”Ÿæˆ</button>
</div>

<div class="layout">
  <div class="pane">

    <!-- STEP1 å·¦ -->
    <div class="sp on" id="ls1">
      <div class="stitle">æ¼«ç”»ãƒšãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€å¤§30æšï¼‰</div>
      <label class="upload-label" id="dropzone">
        <input type="file" id="imgInput" accept="image/*" multiple>
        <span class="upload-icon">ğŸ–¼ï¸</span>
        <p><strong>ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</strong><br>JPGãƒ»PNGãƒ»WebPå¯¾å¿œ ï¼ æœ€å¤§30æš<br>
        <span style="font-size:0.68rem;opacity:0.6;">ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚‚OK</span></p>
      </label>
      <div id="thumbWrap" style="display:none;">
        <div class="thumb-header">
          <p class="img-count">èª­ã¿è¾¼ã¿æ¸ˆï¼š<span id="imgCount">0</span>æš</p>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-sub" style="font-size:0.68rem;padding:4px 10px;" onclick="addMore()">ï¼‹è¿½åŠ </button>
            <button class="btn btn-del" style="padding:4px 10px;font-size:0.68rem;" onclick="clearAll()">å…¨å‰Šé™¤</button>
          </div>
        </div>
        <div class="tip">ğŸ“Œ ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ï¼ˆiPadã¯ã‚¿ãƒƒãƒå¯¾å¿œï¼‰</div>
        <div class="thumb-grid" id="thumbGrid"></div>
      </div>
      <button class="btn btn-main" id="analyzeBtn" onclick="doAnalyze()" disabled>ğŸ” AIã«ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹</button>
    </div>

    <!-- STEP2 å·¦ -->
    <div class="sp" id="ls2">
      <div class="stitle">è©±æ•°ãƒ»åŸºæœ¬æƒ…å ±</div>
      <div class="row2">
        <div class="fg"><label>è©±æ•°ï¼ˆå¿…é ˆï¼‰</label><input type="number" id="epNum" placeholder="ä¾‹: 2" min="1" oninput="updateVol()"></div>
        <div class="fg"><label>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰</label><input type="text" id="epTitle" placeholder="ä¾‹: è¿½ã‚ã‚Œã‚‹å¤©è‰¯æœ¨"></div>
      </div>
      <div class="vinfo" id="vinfo"></div>
      <div class="stitle">ã‚ã‚‰ã™ã˜ï¼ˆAIãŒè‡ªå‹•å…¥åŠ›ãƒ»ç·¨é›†å¯ï¼‰</div>
      <div class="fg"><label>ç™»å ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»èƒ½åŠ›</label><div class="ebox" contenteditable="true" id="f_char" data-ph="AIãŒè‡ªå‹•å…¥åŠ›ã—ã¾ã™"></div></div>
      <div class="fg"><label>ä»Šè©±ã®ã‚ã‚‰ã™ã˜ãƒ»å‡ºæ¥äº‹</label><div class="ebox tall" contenteditable="true" id="f_summ" data-ph="AIãŒè‡ªå‹•å…¥åŠ›ã—ã¾ã™"></div></div>
      <div class="fg"><label>è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ï¼ˆä»»æ„ï¼‰</label><div class="ebox" contenteditable="true" id="f_high" data-ph="AIãŒè‡ªå‹•å…¥åŠ›ã—ã¾ã™"></div></div>
      <div class="fg"><label>æ¬¡è©±ã¸ã®å¼•ãï¼ˆä»»æ„ï¼‰</label><div class="ebox" contenteditable="true" id="f_cliff" data-ph="AIãŒè‡ªå‹•å…¥åŠ›ã—ã¾ã™"></div></div>
      <div class="btn-row">
        <button class="btn btn-sub" onclick="goStep(1)">â† ç”»åƒã«æˆ»ã‚‹</button>
        <button class="btn btn-main" style="margin-top:0;" onclick="goStep(3)">è¨˜äº‹ç”Ÿæˆã¸ â†’</button>
      </div>
    </div>

    <!-- STEP3 å·¦ -->
    <div class="sp" id="ls3">
      <div class="stitle">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯è¨­å®š</div>
      <div class="aff-box">
        <p style="font-size:0.68rem;color:var(--muted);margin-bottom:10px;">9è©±ã”ã¨ã«è‡ªå‹•åˆ‡æ›¿ã€‚1åº¦è¨­å®šã™ã‚Œã°æ¬¡å›ã‚‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <div id="affLinks"></div>
        <div class="tip" style="margin-top:8px;">ğŸ’¡ URLãŒç©ºã®å·»ã¯ã€Œè¿‘æ—¥å…¬é–‹äºˆå®šã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>
      <div class="btn-row" style="margin-bottom:10px;">
        <button class="btn btn-sub" onclick="goStep(2)">â† ã‚ã‚‰ã™ã˜ã«æˆ»ã‚‹</button>
        <button class="btn btn-sub" style="border-color:var(--success);color:var(--success);" onclick="saveAff()">ğŸ’¾ ãƒªãƒ³ã‚¯ã‚’ä¿å­˜</button>
      </div>
      <button class="btn btn-main" id="genBtn" onclick="doGenerate()">âœ¨ noteè¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹</button>
    </div>

  </div>

  <div class="pane pane-r">

    <!-- STEP1 å³ -->
    <div class="rp on" id="rs1">
      <div class="stitle">AIã‚ã‚‰ã™ã˜ç”Ÿæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div class="loading" id="aLoad">
        <div class="spin"></div>
        <div style="flex:1;">
          <div id="aStatus">è§£æä¸­...</div>
          <div class="progress-wrap">
            <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
            <div class="progress-text" id="progText"></div>
          </div>
        </div>
      </div>
      <div class="preview-ph" id="prevPh">
        <span style="font-size:2rem;opacity:0.3;">ğŸ¤–</span>
        <span>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦<br>ã€ŒAIã«ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ã€ã‚’<br>æŠ¼ã™ã¨ã‚ã‚‰ã™ã˜ãŒç”Ÿæˆã•ã‚Œã¾ã™</span>
      </div>
      <div class="preview-box" id="prevBox" style="display:none;"></div>
      <div id="prevActs" style="display:none;margin-top:10px;">
        <div class="ai-badge">âœ¦ AIç”Ÿæˆæ¸ˆã¿</div>
        <p style="font-size:0.7rem;color:var(--muted);margin-bottom:8px;line-height:1.6;">å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œã“ã®ã‚ã‚‰ã™ã˜ã§æ¬¡ã¸ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>STEP2ã§è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ã€‚</p>
        <button class="btn btn-main" onclick="applyNext()">ã“ã®ã‚ã‚‰ã™ã˜ã§æ¬¡ã¸ â†’</button>
        <button class="btn btn-sub" style="width:100%;margin-top:6px;" onclick="reAnalyze()">ğŸ”„ ã‚‚ã†ä¸€åº¦ç”Ÿæˆã™ã‚‹</button>
      </div>
    </div>

    <!-- STEP2 å³ -->
    <div class="rp" id="rs2">
      <div class="stitle">ç·¨é›†ã®ãƒ’ãƒ³ãƒˆ</div>
      <div class="tip">âœï¸ å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†ãƒ»ã‚³ãƒ”ãƒšã§ãã¾ã™</div>
      <div class="tip" style="border-color:var(--accent2);">âš ï¸ ãƒã‚¿ãƒãƒ¬ã®æ·±ã•ã¯ã”è‡ªèº«ã§èª¿æ•´ã—ã¦ãã ã•ã„</div>
      <div class="tip">ğŸ’¡ã€Œè¦‹ã©ã“ã‚ã€ã¨ã€Œæ¬¡è©±ã¸ã®å¼•ãã€ãŒnoteã®ç†±é‡ã‚’æ±ºã‚ã¾ã™ï¼</div>
    </div>

    <!-- STEP3 å³ -->
    <div class="rp" id="rs3">
      <div class="stitle">ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹</div>
      <div class="loading" id="gLoad"><div class="spin"></div> AIãŒè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>
      <div class="out-ph" id="outPh">
        <span style="font-size:2rem;opacity:0.3;">ğŸ“</span>
        <span>ã€Œnoteè¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
      </div>
      <div class="out-box" id="outBox" style="display:none;"></div>
      <div class="out-actions" id="outActs" style="display:none;">
        <span class="copied" id="copiedMsg">âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>
        <button class="btn btn-del" onclick="clearOut()">ã‚¯ãƒªã‚¢</button>
        <button class="btn btn-copy" onclick="doCopy()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

  </div>
</div>

<script>
var images = [];
var aiText = null;
var dragIdx = null;
var MAX = 30;

function goStep(n) {
  [1,2,3].forEach(function(i) {
    document.getElementById('sb'+i).className = 'sbtn' + (i < n ? ' done' : i === n ? ' active' : '');
    document.getElementById('ls'+i).className = 'sp' + (i === n ? ' on' : '');
    document.getElementById('rs'+i).className = 'rp' + (i === n ? ' on' : '');
  });
}

var inp = document.getElementById('imgInput');
var zone = document.getElementById('dropzone');

inp.addEventListener('change', function() { addFiles(this.files); this.value = ''; });
zone.addEventListener('dragover', function(e) { if (dragIdx !== null) return; e.preventDefault(); zone.classList.add('drag'); });
zone.addEventListener('dragleave', function() { zone.classList.remove('drag'); });
zone.addEventListener('drop', function(e) {
  if (dragIdx !== null) return;
  e.preventDefault(); zone.classList.remove('drag');
  addFiles(e.dataTransfer.files);
});

function addMore() { inp.click(); }

function addFiles(files) {
  var arr = Array.from(files);
  var remain = MAX - images.length;
  if (remain <= 0) { alert('æœ€å¤§' + MAX + 'æšã¾ã§ã§ã™'); return; }
  arr.slice(0, remain).forEach(function(f) {
    var r = new FileReader();
    r.onload = function(e) {
      var url = e.target.result;
      images.push({ dataUrl: url, base64: url.split(',')[1], mime: f.type || 'image/jpeg' });
      renderThumbs();
    };
    r.readAsDataURL(f);
  });
}

function renderThumbs() {
  var grid = document.getElementById('thumbGrid');
  var wrap = document.getElementById('thumbWrap');
  grid.innerHTML = '';
  if (images.length === 0) { wrap.style.display = 'none'; document.getElementById('analyzeBtn').disabled = true; return; }
  wrap.style.display = 'block';
  document.getElementById('analyzeBtn').disabled = false;
  document.getElementById('imgCount').textContent = images.length;

  images.forEach(function(img, i) {
    var d = document.createElement('div');
    d.className = 'thumb'; d.draggable = true;
    d.innerHTML = '<img src="' + img.dataUrl + '"><span class="thumb-n">' + (i+1) + '</span><button class="thumb-x" onclick="delImg(' + i + ')">âœ•</button>';

    // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°
    d.addEventListener('dragstart', function(e) { dragIdx = i; setTimeout(function(){ d.classList.add('dragging'); }, 0); e.dataTransfer.effectAllowed = 'move'; });
    d.addEventListener('dragend', function() { dragIdx = null; d.classList.remove('dragging'); document.querySelectorAll('.thumb').forEach(function(t){ t.classList.remove('over'); }); });
    d.addEventListener('dragover', function(e) { e.preventDefault(); document.querySelectorAll('.thumb').forEach(function(t){ t.classList.remove('over'); }); d.classList.add('over'); });
    d.addEventListener('drop', function(e) {
      e.preventDefault(); d.classList.remove('over');
      if (dragIdx === null || dragIdx === i) return;
      var moved = images.splice(dragIdx, 1)[0]; images.splice(i, 0, moved); dragIdx = null; renderThumbs();
    });

    // ã‚¿ãƒƒãƒæ“ä½œï¼ˆiPadå¯¾å¿œï¼‰
    var tsIdx = null, tsEl = null;
    d.addEventListener('touchstart', function(e) { tsIdx = i; tsEl = d; d.classList.add('dragging'); }, { passive: true });
    d.addEventListener('touchmove', function(e) {
      e.preventDefault();
      var t = e.touches[0];
      var el = document.elementFromPoint(t.clientX, t.clientY);
      document.querySelectorAll('.thumb').forEach(function(x){ x.classList.remove('over'); });
      if (el) { var tgt = el.closest('.thumb'); if (tgt && tgt !== d) tgt.classList.add('over'); }
    }, { passive: false });
    d.addEventListener('touchend', function(e) {
      d.classList.remove('dragging');
      document.querySelectorAll('.thumb').forEach(function(x){ x.classList.remove('over'); });
      var t = e.changedTouches[0];
      var el = document.elementFromPoint(t.clientX, t.clientY);
      if (el) {
        var tgt = el.closest('.thumb');
        if (tgt && tgt !== d) {
          var tIdx = parseInt(tgt.querySelector('.thumb-n').textContent) - 1;
          if (!isNaN(tIdx) && tIdx !== tsIdx) { var m = images.splice(tsIdx, 1)[0]; images.splice(tIdx, 0, m); renderThumbs(); }
        }
      }
      tsIdx = null;
    });

    grid.appendChild(d);
  });
}

function delImg(i) { images.splice(i, 1); renderThumbs(); }
function clearAll() { images = []; renderThumbs(); }

function callAPI(messages, maxTok) {
  return fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
    body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: maxTok || 600, messages: messages })
  }).then(function(r){ return r.json(); }).then(function(d){
    if (d.error) throw new Error(d.error.message || 'APIã‚¨ãƒ©ãƒ¼');
    return (d.content || []).map(function(b){ return b.text || ''; }).join('');
  });
}

async function doAnalyze() {
  if (images.length === 0) return;
  document.getElementById('prevPh').style.display = 'none';
  document.getElementById('prevBox').style.display = 'none';
  document.getElementById('prevActs').style.display = 'none';
  document.getElementById('aLoad').className = 'loading on';
  document.getElementById('analyzeBtn').disabled = true;

  var total = images.length;
  var notes = [];

  function setProg(cur, msg) {
    var pct = Math.round((cur / (total + 1)) * 100);
    document.getElementById('progFill').style.width = pct + '%';
    document.getElementById('progText').textContent = msg;
    document.getElementById('aStatus').textContent = 'ãƒšãƒ¼ã‚¸ã‚’èª­ã¿å–ã‚Šä¸­... (' + cur + ' / ' + total + ')';
  }

  try {
    for (var i = 0; i < total; i++) {
      setProg(i, (i+1) + 'æšç›®ã‚’è§£æä¸­...');
      var img = images[i];
      var text = await callAPI([{
        role: 'user',
        content: [
          { type: 'image', source: { type: 'base64', media_type: img.mime, data: img.base64 } },
          { type: 'text', text: 'ã“ã‚Œã¯æ¼«ç”»ã€Œãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚ºã€ã®' + (i+1) + 'ãƒšãƒ¼ã‚¸ç›®ã§ã™ï¼ˆå…¨' + total + 'ãƒšãƒ¼ã‚¸ä¸­ï¼‰ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã«æã‹ã‚Œã¦ã„ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ã‚»ãƒªãƒ•ãƒ»è¡Œå‹•ãƒ»èƒ½åŠ›ãƒ»å ´é¢ã‚’è©³ã—ãç®‡æ¡æ›¸ãã§æ›¸ã„ã¦ãã ã•ã„ã€‚' }
        ]
      }], 500);
      notes.push('ã€' + (i+1) + 'ãƒšãƒ¼ã‚¸ã€‘\n' + text.trim());
    }

    document.getElementById('aStatus').textContent = 'ã‚ã‚‰ã™ã˜ã‚’ç”Ÿæˆä¸­...';
    document.getElementById('progFill').style.width = '95%';
    document.getElementById('progText').textContent = 'ã¾ã¨ã‚ã¦ã„ã¾ã™...';

    var result = await callAPI([{
      role: 'user',
      content: 'ä»¥ä¸‹ã¯æ¼«ç”»ã€Œãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚ºã€ï¼ˆé€±åˆŠå°‘å¹´ã‚µãƒ³ãƒ‡ãƒ¼æ²è¼‰ã€ä½œè€…ï¼šç¦åœ°ç¿¼ï¼‰ã®1è©±åˆ†ãƒ»å…¨' + total + 'ãƒšãƒ¼ã‚¸ã®ãƒ¡ãƒ¢ã§ã™ã€‚\n\n' + notes.join('\n\n') + '\n\n---\nä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š\n\nã€ç™»å ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»èƒ½åŠ›ã€‘\nï¼ˆç®‡æ¡æ›¸ãï¼‰\n\nã€ä»Šè©±ã®ã‚ã‚‰ã™ã˜ãƒ»å‡ºæ¥äº‹ã€‘\nï¼ˆæ™‚ç³»åˆ—ã§ç®‡æ¡æ›¸ã5ã€œ10é …ç›®ï¼‰\n\nã€è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ã€‘\nï¼ˆ3ã€œ5ç‚¹ï¼‰\n\nã€æ¬¡è©±ã¸ã®å¼•ããƒ»æ°—ã«ãªã‚‹ç‚¹ã€‘\nï¼ˆãªã‘ã‚Œã°ã€Œç‰¹ã«ãªã—ã€ï¼‰'
    }], 1000);

    document.getElementById('progFill').style.width = '100%';
    document.getElementById('progText').textContent = 'å®Œäº†ï¼';
    aiText = result;
    document.getElementById('prevBox').textContent = result;
    document.getElementById('prevBox').style.display = 'block';
    document.getElementById('prevActs').style.display = 'block';
  } catch(e) {
    document.getElementById('prevBox').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
    document.getElementById('prevBox').style.display = 'block';
  }

  document.getElementById('aLoad').className = 'loading';
  document.getElementById('analyzeBtn').disabled = false;
}

function reAnalyze() {
  document.getElementById('prevBox').style.display = 'none';
  document.getElementById('prevActs').style.display = 'none';
  document.getElementById('prevPh').style.display = 'flex';
  doAnalyze();
}

function extract(text, from, to) {
  var s = text.indexOf(from); if (s === -1) return '';
  s += from.length;
  var e = to ? text.indexOf(to) : text.length; if (e === -1) e = text.length;
  return text.slice(s, e).trim();
}

function applyNext() {
  if (!aiText) { goStep(2); return; }
  document.getElementById('f_char').innerText = extract(aiText, 'ã€ç™»å ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»èƒ½åŠ›ã€‘', 'ã€ä»Šè©±ã®ã‚ã‚‰ã™ã˜ãƒ»å‡ºæ¥äº‹ã€‘');
  document.getElementById('f_summ').innerText = extract(aiText, 'ã€ä»Šè©±ã®ã‚ã‚‰ã™ã˜ãƒ»å‡ºæ¥äº‹ã€‘', 'ã€è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ã€‘');
  document.getElementById('f_high').innerText = extract(aiText, 'ã€è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ã€‘', 'ã€æ¬¡è©±ã¸ã®å¼•ããƒ»æ°—ã«ãªã‚‹ç‚¹ã€‘');
  var cliff = extract(aiText, 'ã€æ¬¡è©±ã¸ã®å¼•ããƒ»æ°—ã«ãªã‚‹ç‚¹ã€‘', null);
  document.getElementById('f_cliff').innerText = cliff === 'ç‰¹ã«ãªã—' ? '' : cliff;
  goStep(2);
}

function updateVol() {
  var ep = parseInt(document.getElementById('epNum').value) || 0;
  var el = document.getElementById('vinfo');
  if (!ep) { el.style.display = 'none'; return; }
  var vol = Math.ceil(ep / 9);
  el.style.display = 'block';
  el.textContent = 'ğŸ“š ç¬¬' + ep + 'è©± â†’ ç¬¬' + vol + 'å·»ã«ç›¸å½“ï¼ˆ' + vol + 'å·»ãƒªãƒ³ã‚¯ã‚’è‡ªå‹•ä½¿ç”¨ï¼‰';
}

var affData = {};
function loadAff() {
  try { var s = localStorage.getItem('para_aff'); if (s) affData = JSON.parse(s); } catch(e) {}
  if (!affData[1]) affData[1] = 'https://amzn.to/3MO2hjh';
}
function saveAff() {
  for (var v = 1; v <= 8; v++) { var el = document.getElementById('aff'+v); if (el) affData[v] = el.value.trim(); }
  try { localStorage.setItem('para_aff', JSON.stringify(affData)); } catch(e) {}
  alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
}
function initAff() {
  loadAff();
  var c = document.getElementById('affLinks'); c.innerHTML = '';
  for (var v = 1; v <= 8; v++) {
    var row = document.createElement('div'); row.className = 'aff-row';
    row.innerHTML = '<span class="vol-tag">' + v + 'å·»</span><input class="aff-in" type="text" id="aff' + v + '" placeholder="https://amzn.to/..." value="' + (affData[v] || '') + '">';
    c.appendChild(row);
  }
}
function getAff(vol) { var el = document.getElementById('aff'+vol); return el ? el.value.trim() : (affData[vol] || ''); }

async function doGenerate() {
  var ep = document.getElementById('epNum').value;
  var title = document.getElementById('epTitle').value.trim();
  var chars = (document.getElementById('f_char').innerText || '').trim();
  var summ  = (document.getElementById('f_summ').innerText || '').trim();
  var high  = (document.getElementById('f_high').innerText || '').trim();
  var cliff = (document.getElementById('f_cliff').innerText || '').trim();

  if (!ep || !summ) { alert('è©±æ•°ã¨ã‚ã‚‰ã™ã˜ã¯å¿…é ˆã§ã™ï¼STEP2ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); goStep(2); return; }

  var vol = Math.ceil(parseInt(ep) / 9);
  var affUrl = getAff(vol);
  var tPart = title ? 'ã€Œ' + title + 'ã€' : '';
  var affPart = affUrl ? '\n\nè¨˜äº‹æœ«å°¾ã«ä»¥ä¸‹ã®ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’è‡ªç„¶ã«æŒ¿å…¥ã—ã¦ãã ã•ã„ï¼ˆURLã¯ãã®ã¾ã¾ï¼‰ï¼š\nâ–¼ã€ãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚ºã€ç¬¬' + vol + 'å·»ã¯ã“ã¡ã‚‰\n' + affUrl : '';
  var prompt = 'ã‚ãªãŸã¯æ¼«ç”»ãƒ–ãƒ­ã‚¬ãƒ¼ã§ã™ã€‚é€±åˆŠå°‘å¹´ã‚µãƒ³ãƒ‡ãƒ¼æ²è¼‰ã€Œãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚ºã€ï¼ˆä½œè€…ï¼šç¦åœ°ç¿¼ï¼‰ã®ç¬¬' + ep + 'è©±' + tPart + 'ã®noteè¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚\n\nã€ç™»å ´ã‚­ãƒ£ãƒ©ãƒ»èƒ½åŠ›ã€‘\n' + (chars||'ï¼ˆãªã—ï¼‰') + '\n\nã€ã‚ã‚‰ã™ã˜ãƒ»å‡ºæ¥äº‹ã€‘\n' + summ + '\n\nã€è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ã€‘\n' + (high||'ï¼ˆãªã—ï¼‰') + '\n\nã€æ¬¡è©±ã¸ã®å¼•ãã€‘\n' + (cliff||'ï¼ˆãªã—ï¼‰') + '\n\n---\nãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼šãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚ºãŒæ°—ã«ãªã‚‹äººãƒ»èª­ã¿å§‹ã‚ãŸäºº\nãƒ»ãƒˆãƒ¼ãƒ³ï¼šç†±é‡ã‚ã‚Šã€èª­ã¿ã‚„ã™ãã€ãƒ†ãƒ³ãƒã‚ˆã\nãƒ»æ§‹æˆï¼šâ‘ ã‚­ãƒ£ãƒƒãƒãƒ¼ãªã‚¿ã‚¤ãƒˆãƒ« â‘¡ã‚ã‚‰ã™ã˜ï¼ˆå¤ªå­—ãƒ»æ”¹è¡Œã§èª­ã¿ã‚„ã™ãï¼‰ â‘¢è¦‹ã©ã“ã‚ãƒ»æ„Ÿæƒ³ â‘£æ¬¡è©±ã¸ã®æœŸå¾…\nãƒ»çµµæ–‡å­—ã¯é©åº¦ã«\nãƒ»æœ€å¾Œã«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°10å€‹ä»¥ä¸Šï¼ˆ#ãƒ‘ãƒ©ã‚·ãƒ§ãƒƒãƒ‘ãƒ¼ã‚º #ç¦åœ°ç¿¼ #é€±åˆŠå°‘å¹´ã‚µãƒ³ãƒ‡ãƒ¼ å¿…é ˆï¼‰' + affPart + '\n\nã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å§‹ã‚ã¦ã€ãã®ã¾ã¾noteã«ã‚³ãƒ”ãƒšã§ãã‚‹å½¢å¼ã§æ›¸ã„ã¦ãã ã•ã„ã€‚';

  document.getElementById('outPh').style.display = 'none';
  document.getElementById('outBox').style.display = 'none';
  document.getElementById('outActs').style.display = 'none';
  document.getElementById('gLoad').className = 'loading on';
  document.getElementById('genBtn').disabled = true;

  try {
    var result = await callAPI([{ role: 'user', content: prompt }], 1000);
    document.getElementById('outBox').textContent = result;
    document.getElementById('outBox').style.display = 'block';
    document.getElementById('outActs').style.display = 'flex';
    document.getElementById('outPh').style.display = 'none';
  } catch(e) {
    document.getElementById('outBox').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
    document.getElementById('outBox').style.display = 'block';
    document.getElementById('outActs').style.display = 'flex';
  }
  document.getElementById('gLoad').className = 'loading';
  document.getElementById('genBtn').disabled = false;
}

function doCopy() {
  var text = document.getElementById('outBox').textContent;
  navigator.clipboard.writeText(text).then(function() {
    var el = document.getElementById('copiedMsg'); el.className = 'copied on';
    setTimeout(function(){ el.className = 'copied'; }, 2500);
  });
}

function clearOut() {
  document.getElementById('outBox').style.display = 'none';
  document.getElementById('outActs').style.display = 'none';
  document.getElementById('outPh').style.display = 'flex';
}

initAff();
</script>
</body>
</html>
